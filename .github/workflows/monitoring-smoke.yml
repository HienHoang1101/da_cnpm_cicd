name: Monitoring Smoke Test
    name: Monitoring /metrics smoke check
name: Monitoring Smoke Test

on:
  pull_request:
    paths:
      - 'monitoring/**'
      - 'docker-compose.monitoring.yml'
      - '.github/workflows/**'
  workflow_dispatch: {}

jobs:
  runner-diagnostics:
    name: Runner diagnostics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect runner Docker info
        run: |
          set -eux
          mkdir -p monitoring/artifacts
          echo "== uname -a ==" > monitoring/artifacts/runner-diag.txt
          uname -a >> monitoring/artifacts/runner-diag.txt 2>&1 || true
          echo "\n== df -h ==" >> monitoring/artifacts/runner-diag.txt
          df -h >> monitoring/artifacts/runner-diag.txt 2>&1 || true
          echo "\n== docker --version ==" >> monitoring/artifacts/runner-diag.txt
          docker --version >> monitoring/artifacts/runner-diag.txt 2>&1 || true
          echo "\n== docker info ==" >> monitoring/artifacts/runner-diag.txt
          docker info >> monitoring/artifacts/runner-diag.txt 2>&1 || true
          echo "\n== docker compose version ==" >> monitoring/artifacts/runner-diag.txt
          docker compose version >> monitoring/artifacts/runner-diag.txt 2>&1 || true
          echo "\n== docker ps (short) ==" >> monitoring/artifacts/runner-diag.txt
          docker ps --format "table {{.Names}}\t{{.Status}}" >> monitoring/artifacts/runner-diag.txt 2>&1 || true

      - name: Upload runner diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-diag
          path: monitoring/artifacts/runner-diag.txt

  smoke-check:
    name: Monitoring /metrics smoke check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start monitoring stack (build + up)
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
        run: |
          set -eux
          # Ensure a local Mongo is available for services
          if [ -z "$(docker ps -q -f name=monitoring-mongo)" ]; then
            docker run -d --name monitoring-mongo -p 27017:27017 mongo:5.0 || true
          else
            echo "monitoring-mongo already running"
          fi

          # Build and start services using the compose override
          docker compose -f docker-compose.yml -f docker-compose.monitoring.yml build --parallel
          docker compose -f docker-compose.yml -f docker-compose.monitoring.yml up --pull always -d monitoring-mongo auth-service order-service payment-service delivery-service admin-service || true

          echo "Containers after docker-compose up:"
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Debug: recent logs
        run: |
          set -eux
          sleep 8
          docker ps --format "table {{.Names}}\t{{.Status}}"
          docker logs --tail 200 auth-service || true
          docker logs --tail 200 order-service || true
          docker logs --tail 200 payment-service || true
          docker logs --tail 200 delivery-service || true
          docker logs --tail 200 admin-service || true

      - name: Install monitoring dependencies
        run: |
          set -eux
          npm ci --prefix ./monitoring || npm install --prefix ./monitoring

      - name: Run metrics smoke-check (outputs to monitoring/artifacts)
        id: smoke
        run: |
          set -eux
          mkdir -p monitoring/artifacts
          # Run smoke-check and always write output files for artifacts
          node monitoring/tests/check-metrics.js > monitoring/artifacts/smoke-output.txt 2>&1 || echo "SMOKE_EXIT=$?" > monitoring/artifacts/smoke-exit.txt

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-smoke
          path: monitoring/artifacts/**

      - name: Publish JUnit results to PR checks
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: monitoring-smoke
          path: monitoring/artifacts/smoke-result.xml
          reporter: junit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tear down stack
        if: always()
        run: |
          set -eux || true
          docker compose -f docker-compose.yml -f docker-compose.monitoring.yml down -v || true

      - name: Fail if smoke-test failed
        if: always()
        run: |
          if [ -f monitoring/artifacts/smoke-exit.txt ]; then
            echo "Smoke test reported non-zero exit"; cat monitoring/artifacts/smoke-output.txt || true; exit 1
          else
            echo "Smoke test artifacts indicate success (or no explicit exit file)."; cat monitoring/artifacts/smoke-output.txt || true
          fi

